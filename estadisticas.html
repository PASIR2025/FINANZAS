<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estad√≠sticas de Ventas y Utilidad</title>
<meta name="theme-color" content="#0d1b2a">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --fondo:#0d1b2a; --panel:#1b263b; --acento:#3a86ff;
  --texto:#e0e6ed; --verde:#38b000; --naranja:#ff9f1c; --rosa:#ff4d6d;
}
*{box-sizing:border-box;}
body{
  font-family:'Segoe UI',sans-serif;
  background:var(--fondo);
  color:var(--texto);
  margin:0; padding:20px;
}
h1{text-align:center;color:var(--acento);margin:0 0 1rem;}
button,input{font-size:1rem;}
button{
  background:var(--acento);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin:4px 0;
  transition:.2s;
}
button:hover{background:#2f6ed0;}
input[type="date"]{
  background:#27354a;
  color:var(--texto);
  border:none;
  padding:8px;
  border-radius:6px;
}
.panel{
  background:var(--panel);
  padding:20px;
  margin-bottom:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
}
#listaVentas{
  max-height:180px;
  overflow-y:auto;
  padding-right:5px;
  margin-top:15px;
}
.graficos{
  display:grid;
  grid-template-columns:1fr;
  gap:20px;
}
@media(min-width:1100px){
  .graficos{grid-template-columns:1fr 1fr 1fr;}
}
.chart-wrap{
  background:var(--panel);
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
  height:340px;
}
canvas{width:100% !important;height:100% !important;}
</style>
</head>
<body>

<h1>üìä Ventas y Utilidad</h1>
<div style="text-align:center;margin-bottom:15px;">
  <button onclick="window.location.href='index.html'">‚¨ÖÔ∏è Volver</button>
  <button onclick="imprimir()">üñ®Ô∏è Imprimir</button>
  <button onclick="descargar()">üíæ Guardar Datos</button>
</div>

<div class="panel">
  <h2>Filtrar Rango de Fechas</h2>
  <label>Desde: <input type="date" id="desdeVenta"></label>
  <label>Hasta: <input type="date" id="hastaVenta"></label>
  <button onclick="mostrarEstadisticas()">Filtrar</button>
  <div id="listaVentas"></div>
</div>

<!-- ===== GRAFICOS ===== -->
<div class="graficos">
  <div class="chart-wrap">
    <h3 style="text-align:center;margin-top:0;">Ventas por D√≠a</h3>
    <canvas id="graficoDias"></canvas>
  </div>
  <div class="chart-wrap">
    <h3 style="text-align:center;margin-top:0;">Ventas por Mes</h3>
    <canvas id="graficoMes"></canvas>
  </div>
  <div class="chart-wrap">
    <h3 style="text-align:center;margin-top:0;">Ventas por A√±o</h3>
    <canvas id="graficoAnual"></canvas>
  </div>
</div>

<!-- UTILIDAD -->
<div class="graficos" style="margin-top:30px;">
  <div class="chart-wrap">
    <h3 style="text-align:center;margin-top:0;">Utilidad por Mes</h3>
    <canvas id="graficoUtilMes"></canvas>
  </div>
  <div class="chart-wrap">
    <h3 style="text-align:center;margin-top:0;">Utilidad por A√±o</h3>
    <canvas id="graficoUtilAnual"></canvas>
  </div>
</div>

<script>
const movimientos = JSON.parse(localStorage.getItem("finanzasMovimientos") || "[]");
const ratesData = JSON.parse(localStorage.getItem("fxRates") || "{}");
let rates = ratesData.rates || {PEN:3.8, EUR:0.9};

function getFactor(moneda='USD'){
  if(moneda==='USD') return 1;
  if(moneda==='PEN') return rates.PEN || 1;
  if(moneda==='EUR') return rates.EUR || 1;
  return 1;
}
const moneda = 'USD';
function formatCurrency(v){
  return `${(v * getFactor(moneda)).toFixed(2)} ${moneda}`;
}

function mostrarEstadisticas(){
  const desde=document.getElementById('desdeVenta').value;
  const hasta=document.getElementById('hastaVenta').value;
  const lista=document.getElementById('listaVentas');
  let filtrados = movimientos;
  if(desde) filtrados = filtrados.filter(m => m.fecha.slice(0,10) >= desde);
  if(hasta) filtrados = filtrados.filter(m => m.fecha.slice(0,10) <= hasta);

  // Lista
  lista.innerHTML = filtrados.map(m => {
    const f = new Date(m.fecha);
    const sign = m.tipo==='ingreso'?'+':'-';
    return `<p>${f.toLocaleDateString()} - ${m.billetera}: ${sign}${formatCurrency(m.monto)}</p>`;
  }).join('') || '<em>Sin registros</em>';

  // ========= GRAFICOS VENTA =========
  const ingresos = filtrados.filter(m=>m.tipo==='ingreso');
  // por d√≠a
  const porDia = {};
  ingresos.forEach(m => {
    const d = m.fecha.slice(0,10);
    porDia[d] = (porDia[d]||0) + m.monto;
  });
  const dias = Object.keys(porDia).sort();
  const dataDia = dias.map(d => porDia[d] * getFactor(moneda));
  if(window.grafDia) window.grafDia.destroy();
  window.grafDia = new Chart(document.getElementById('graficoDias'), {
    type: 'line',
    data: {
      labels: dias,
      datasets: [{
        label:`Ventas (${moneda})`,
        data: dataDia,
        borderColor:'#3a86ff',
        backgroundColor:'rgba(58,134,255,0.15)',
        tension:0.3,
        pointRadius:5,
        pointBackgroundColor:'#3a86ff'
      }]
    },
    options: {plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}},maintainAspectRatio:false}
  });

  // por mes
  const porMes = {};
  ingresos.forEach(m => {
    const d = new Date(m.fecha);
    const k = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
    porMes[k] = (porMes[k]||0) + m.monto;
  });
  const meses = Object.keys(porMes).sort();
  const dataMes = meses.map(k => porMes[k] * getFactor(moneda));
  if(window.grafMes) window.grafMes.destroy();
  window.grafMes = new Chart(document.getElementById('graficoMes'), {
    type: 'line',
    data: {
      labels: meses,
      datasets: [{
        label:`Ventas Mensuales (${moneda})`,
        data: dataMes,
        borderColor:'#38b000',
        backgroundColor:'rgba(56,176,0,0.15)',
        tension:0.3,
        pointRadius:5,
        pointBackgroundColor:'#38b000'
      }]
    },
    options: {plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}},maintainAspectRatio:false}
  });

  // por a√±o
  const porAnio = {};
  ingresos.forEach(m => {
    const d = new Date(m.fecha);
    const k = d.getFullYear();
    porAnio[k] = (porAnio[k]||0) + m.monto;
  });
  const anios = Object.keys(porAnio).sort();
  const dataAnio = anios.map(k => porAnio[k] * getFactor(moneda));
  if(window.grafAnual) window.grafAnual.destroy();
  window.grafAnual = new Chart(document.getElementById('graficoAnual'), {
    type: 'bar',
    data: {
      labels: anios,
      datasets: [{
        label:`Ventas Anuales (${moneda})`,
        data: dataAnio,
        backgroundColor:'rgba(255,159,28,0.7)',
        borderColor:'#ff9f1c',
        borderWidth:1
      }]
    },
    options: {plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}},maintainAspectRatio:false}
  });

  // ========= GRAFICOS UTILIDAD =========
  // Utilidad = ingresos - gastos
  const porMesUtil = {};
  const porAnioUtil = {};
  filtrados.forEach(m=>{
    const d = new Date(m.fecha);
    const mesKey = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
    const anioKey = d.getFullYear();
    const val = m.tipo==='ingreso'? m.monto : -m.monto;
    porMesUtil[mesKey] = (porMesUtil[mesKey]||0) + val;
    porAnioUtil[anioKey] = (porAnioUtil[anioKey]||0) + val;
  });
  const mesesU = Object.keys(porMesUtil).sort();
  const dataMesU = mesesU.map(k => porMesUtil[k] * getFactor(moneda));
  if(window.grafUtilMes) window.grafUtilMes.destroy();
  window.grafUtilMes = new Chart(document.getElementById('graficoUtilMes'), {
    type: 'bar',
    data: {
      labels: mesesU,
      datasets: [{
        label:`Utilidad Mensual (${moneda})`,
        data: dataMesU,
        backgroundColor:dataMesU.map(v=> v>=0?'rgba(56,176,0,0.7)':'rgba(255,77,109,0.7)'),
        borderColor:dataMesU.map(v=> v>=0?'#38b000':'#ff4d6d'),
        borderWidth:1
      }]
    },
    options: {plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}},maintainAspectRatio:false}
  });

  const aniosU = Object.keys(porAnioUtil).sort();
  const dataAnioU = aniosU.map(k => porAnioUtil[k] * getFactor(moneda));
  if(window.grafUtilAnual) window.grafUtilAnual.destroy();
  window.grafUtilAnual = new Chart(document.getElementById('graficoUtilAnual'), {
    type: 'bar',
    data: {
      labels: aniosU,
      datasets: [{
        label:`Utilidad Anual (${moneda})`,
        data: dataAnioU,
        backgroundColor:dataAnioU.map(v=> v>=0?'rgba(56,176,0,0.7)':'rgba(255,77,109,0.7)'),
        borderColor:dataAnioU.map(v=> v>=0?'#38b000':'#ff4d6d'),
        borderWidth:1
      }]
    },
    options: {plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}},maintainAspectRatio:false}
  });
}

// === Imprimir y Guardar ===
function imprimir(){ window.print(); }
function descargar(){
  const blob = new Blob([JSON.stringify(movimientos,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'finanzas_respaldo.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

mostrarEstadisticas();
</script>
</body>
</html>
