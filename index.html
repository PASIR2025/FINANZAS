<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Finanzas Diarias ‚Äì PWA</title>
<meta name="theme-color" content="#0d1b2a">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --fondo:#0d1b2a; --panel:#1b263b; --acento:#3a86ff;
    --texto:#e0e6ed; --verde:#38b000; --rojo:#e63946;
  }
  body{font-family:'Segoe UI',sans-serif;background:var(--fondo);color:var(--texto);margin:0;padding:20px;line-height:1.6;}
  h1{text-align:center;color:var(--acento);margin:0 0 1rem;}
  .panel{background:var(--panel);padding:20px;margin-bottom:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
  h2{color:var(--acento);margin-top:0;}
  /* Nuevo estilo para el t√≠tulo del panel expandible */
  h2.toggle-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  h2.toggle-header .arrow { transition: transform 0.3s; }
  h2.toggle-header.expanded .arrow { transform: rotate(180deg); }

  input,select,button{width:100%;padding:10px;margin-top:8px;border:none;border-radius:8px;font-size:1rem;}
  input,select{background:#27354a;color:var(--texto);}
  button{background:var(--acento);color:#fff;font-weight:bold;cursor:pointer;transition:background 0.2s;border:none;}
  button:hover{background:#2f6ed0;}
  table{width:100%;border-collapse:collapse;margin-top:15px;font-size:0.9rem;}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #31445e;}
  tr.ingreso td{color:var(--verde);font-weight:bold;}
  tr.gasto td{color:var(--rojo);font-weight:bold;}
  tr:hover{background:#2a3950;cursor:pointer;}
  .acciones{display:none;text-align:right;}
  tr.activo .acciones{display:block;}
  .acciones button{width:auto;padding:4px 8px;font-size:0.8rem;margin-left:4px;}
  .balance-box{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-around;margin-top:10px;}
  .balance-item{background:#27354a;padding:15px;border-radius:10px;text-align:center;flex:1 1 120px;min-width:120px;font-size:1rem;}
  .verde{color:var(--verde);font-weight:bold;}
  .rojo{color:var(--rojo);font-weight:bold;}
  .saldos{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px;}
  .saldo-box{background:#27354a;padding:12px;border-radius:10px;text-align:center;font-weight:600;cursor:pointer;transition:background 0.2s;}
  .saldo-box:hover{background:#344a63;}
  .saldo-monto{font-size:1.1rem;font-weight:bold;}
  #paginaVentas{display:none;}
  /* icon buttons */
  .icon-bar{display:flex;justify-content:flex-end;gap:8px;margin-bottom:12px;}
  .icon-btn{
    background:transparent;border:1px solid rgba(255,255,255,0.06);
    color:var(--acento);border-radius:50%;width:40px;height:40px;
    display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;
  }
  .icon-btn:hover{background:rgba(255,255,255,0.02);}
  @media print {
    button, input, select {display:none !important;}
    body {background:#fff;color:#000;}
    .panel {background:#fff;box-shadow:none;}
  }
</style>
</head>
<body>

<h1>üí∞ Finanzas Diarias</h1>

<div class="icon-bar">
  <button class="icon-btn" title="Importar respaldo" onclick="importarRespaldo()">‚¨ÜÔ∏è</button>
  <button class="icon-btn" title="Exportar respaldo" onclick="exportarRespaldo()">‚¨áÔ∏è</button>
</div>

<div class="panel">
  <h2>Moneda de visualizaci√≥n</h2>
  <label>Moneda
    <select id="monedaSelect">
      <option value="USD">USD (base)</option>
      <option value="PEN">PEN ‚Äì Soles</option>
      <option value="EUR">EUR ‚Äì Euro</option>
    </select>
  </label>
  <p><strong>Tasa de cambio actual:</strong> <span id="tasaAuto">Cargando‚Ä¶</span></p>
  <small>Los datos se guardan en <strong>USD</strong> y solo se convierten al mostrar.</small>
</div>

<div id="paginaPrincipal">
  <div class="panel">
    <h2>Registrar Movimiento</h2>
    <label>Tipo
      <select id="tipo">
        <option value="ingreso">Ingreso</option>
        <option value="gasto">Gasto</option>
      </select>
    </label>
    <label>Monto (USD)<input type="number" id="monto" placeholder="Ej: 150.00"></label>
    <label>Billetera
      <select id="billetera"></select>
    </label>
    <label>Fecha
      <input type="date" id="fechaMov">
    </label>
    <label>Descripci√≥n (opcional)
      <input type="text" id="descripcion" placeholder="Detalle del movimiento">
    </label>
    <button onclick="agregarMovimiento()">Agregar</button>
    <button onclick="window.print()">üñ®Ô∏è Imprimir / Guardar PDF</button>
  </div>

  <div class="panel">
    <h2>Balance General</h2>
    <div class="balance-box">
      <div class="balance-item verde"><strong>Ingresos</strong><br><span id="ingresosTotal">0</span></div>
      <div class="balance-item rojo"><strong>Gastos</strong><br><span id="gastosTotal">0</span></div>
      <div class="balance-item"><strong>Saldo Neto</strong><br><span id="saldoNeto">0</span></div>
    </div>
  </div>

  <div class="panel" style="cursor:pointer;" onclick="window.location.href='estadisticas.html'">
  <h2>Ventas del D√≠a (clic para ver estad√≠sticas)</h2>
    <div class="balance-item verde" style="margin:auto;max-width:220px;">
      <strong>Total vendido hoy</strong><br><span id="ventasHoy">0</span>
    </div>
  </div>

  <div class="panel">
    <h2>Saldos por Billetera</h2>
    <div class="saldos" id="saldos"></div>
  </div>

  <div class="panel">
    <h2 class="toggle-header" onclick="toggleWallets()">
      <span>Administrar Billeteras</span>
      <span class="arrow">‚ñº</span>
    </h2>
    <div id="walletsContainer" style="display:none;">
      <div class="saldos" id="listaBilleteras"></div>
      <label>
        Nueva billetera
        <input type="text" id="nuevaBilleteraInput" placeholder="Ej: Billetera Nueva">
      </label>
      <button onclick="agregarBilletera()">A√±adir billetera</button>
    </div>
  </div>

  <div class="panel">
    <h2>Historial</h2>
    <label>Filtrar por mes:
      <input type="month" id="mesFiltro" onchange="renderTodo()">
    </label>
    <table id="tabla">
      <thead>
        <tr><th>Fecha</th><th>Billetera</th><th>Descripci√≥n</th><th>Monto</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3>Total del mes: <span id="totalMes">0</span></h3>
  </div>
</div>

<div id="paginaVentas">
  <button onclick="cerrarPaginaVentas()" style="margin-bottom:15px;">‚¨ÖÔ∏è Volver</button>
  <div class="panel">
    <h2>Estad√≠sticas de Ventas</h2>
    <label>Desde: <input type="date" id="desdeVenta"></label>
    <label>Hasta: <input type="date" id="hastaVenta"></label>
    <button onclick="mostrarEstadisticas()">Filtrar</button>
    <div id="listaVentas" style="margin-top:15px;"></div>
  </div>
  <div class="panel">
    <h3>Ventas por D√≠a</h3>
    <canvas id="graficoDias" height="200"></canvas>
  </div>
  <div class="panel">
    <h3>Ventas por Mes</h3>
    <canvas id="graficoMes" height="200"></canvas>
  </div>
</div>

<script>
/* ========== Datos & almacenamiento ========== */
const LS_KEY="finanzasMovimientos";
const LS_BACKUP_KEY="finanzas_backup";
let movimientos = JSON.parse(localStorage.getItem(LS_KEY)) || [];

const WALLETS_LS_KEY = 'finanzasWallets';
let billeteras = JSON.parse(localStorage.getItem(WALLETS_LS_KEY)) || ["PayPal","Payoneer","Hotmart","Yape","Western Union","MoneyGram","Binance","Efectivo"];

/* guarda y tambi√©n respalda autom√°ticamente en otra clave */
function guardar(){
  localStorage.setItem(LS_KEY, JSON.stringify(movimientos));
  // respaldo local autom√°tico (por si acaso)
  try { localStorage.setItem(LS_BACKUP_KEY, JSON.stringify({at: new Date().toISOString(), data: movimientos})); } catch(e) {}
}

function guardarBilleteras(){
  localStorage.setItem(WALLETS_LS_KEY, JSON.stringify(billeteras));
}

/* ========== Import / Export (respaldo) ========== */
function exportarRespaldo(){
  const data = JSON.stringify(movimientos, null, 2);
  const blob = new Blob([data], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `finanzas_respaldo_${ts}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importarRespaldo(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const fr = new FileReader();
    fr.onload = () => {
      try {
        const parsed = JSON.parse(fr.result);
        if(!Array.isArray(parsed)) {
          // maybe file stored with wrapper {data: [...]}
          if(parsed && parsed.data && Array.isArray(parsed.data)) {
            handleImportArray(parsed.data);
            return;
          }
          throw new Error('Formato inv√°lido');
        }
        handleImportArray(parsed);
      } catch(err) {
        alert("Archivo inv√°lido: " + (err.message||err));
      }
    };
    fr.readAsText(file);
  };
  inp.click();
}

function handleImportArray(arr){
  if(!confirm("¬øDeseas reemplazar tus datos actuales? (Aceptar = reemplazar, Cancelar = agregar sin duplicados)")) {
    // agregar sin duplicados (por id)
    const existingIds = new Set(movimientos.map(m=>m.id));
    let added = 0;
    arr.forEach(item=>{
      if(!item || !item.id) {
        // ensure id
        item.id = Date.now() + Math.floor(Math.random()*10000);
      }
      if(!existingIds.has(item.id)){
        movimientos.push(item);
        existingIds.add(item.id);
        added++;
      }
    });
    guardar(); renderTodo();
    alert(`Se agregaron ${added} movimientos (sin duplicar).`);
    return;
  }
  // Reemplazar por completo
  movimientos = arr.map(item => {
    if(!item.id) item.id = Date.now() + Math.floor(Math.random()*10000);
    return item;
  });
  guardar(); renderTodo();
  alert("Respaldo cargado y datos reemplazados.");
}

/* ========== Tipo de cambio autom√°tico ========== */
let rates = {PEN: 3.8, EUR: 0.9};
const RATES_LS_KEY = 'fxRates';

function loadRatesFromStorage(){
  try{
    const s = localStorage.getItem(RATES_LS_KEY);
    if(s){
      const parsed = JSON.parse(s);
      if(parsed && parsed.rates) rates = parsed.rates;
    }
  }catch(e){}
}
loadRatesFromStorage();

async function actualizarTasas(){
  try{
    // API gratuita: base USD
    const res = await fetch("https://open.er-api.com/v6/latest/USD");
    const j = await res.json();
    if(j && j.rates){
      if(j.rates.PEN) rates.PEN = j.rates.PEN;
      if(j.rates.EUR) rates.EUR = j.rates.EUR;
      // guardar
      try { localStorage.setItem(RATES_LS_KEY, JSON.stringify({at:new Date().toISOString(), rates})); } catch(e){}
      document.getElementById('tasaAuto').textContent = `1 USD = ${rates.PEN.toFixed(2)} PEN ¬∑ 1 USD = ${rates.EUR.toFixed(4)} EUR`;
      renderTodo();
      return;
    }
    throw new Error('Sin rates en respuesta');
  }catch(err){
    // usa almacenado si falla
    loadRatesFromStorage();
    document.getElementById('tasaAuto').textContent = `1 USD = ${rates.PEN.toFixed(2)} PEN ¬∑ 1 USD = ${rates.EUR.toFixed(4)} EUR (offline)`;
  }
}
actualizarTasas();
setInterval(actualizarTasas, 10 * 60 * 1000); // cada 10 minutos

/* factor de conversi√≥n */
function getFactor(){
  const sel = document.getElementById('monedaSelect').value;
  if(sel === 'USD') return 1;
  if(sel === 'PEN') return rates.PEN || 1;
  if(sel === 'EUR') return rates.EUR || 1;
  return 1;
}
function formatCurrency(v){
  const sel = document.getElementById('monedaSelect').value;
  const f = getFactor();
  return `${(v * f).toFixed(2)} ${sel}`;
}
document.getElementById('monedaSelect').addEventListener('change', renderTodo);

/* ========== Billeteras: agregar/eliminar/render ========== */
function agregarBilletera(){
  const input = document.getElementById('nuevaBilleteraInput');
  const nombre = input.value.trim();
  if(!nombre || billeteras.includes(nombre)) return;
  billeteras.push(nombre);
  input.value = '';
  guardarBilleteras();
  renderWallets();
  renderTodo();
}

function eliminarBilletera(nombre){
  if(!confirm(`¬øEliminar la billetera "${nombre}"?`)) return;
  billeteras = billeteras.filter(b => b !== nombre);
  guardarBilleteras();
  renderWallets();
  renderTodo();
}

function renderWallets(){
  const select = document.getElementById('billetera');
  select.innerHTML = billeteras.map(b => `<option>${b}</option>`).join('');

  const lista = document.getElementById('listaBilleteras');
  lista.innerHTML = billeteras.map(b => `
    <div class="saldo-box" style="display:flex;align-items:center;justify-content:space-between;">
      <span>${b}</span>
      <button onclick="event.stopPropagation();eliminarBilletera('${b}')" style="width:auto;padding:4px 8px;font-size:0.8rem;background:var(--rojo);">X</button>
    </div>
  `).join('');
}

function toggleWallets() {
  const container = document.getElementById('walletsContainer');
  const title = document.querySelector('.toggle-header');
  if (container.style.display === 'none') {
    container.style.display = 'block';
    title.classList.add('expanded');
  } else {
    container.style.display = 'none';
    title.classList.remove('expanded');
  }
}

/* ========== Movimientos: agregar/editar/eliminar ========== */
function agregarMovimiento(){
  const tipo = document.getElementById('tipo').value;
  const monto = parseFloat(document.getElementById('monto').value);
  const billetera = document.getElementById('billetera').value;
  const desc = document.getElementById('descripcion').value;
  const fechaSel = document.getElementById('fechaMov').value;
  if(isNaN(monto) || monto <= 0){ alert("Monto inv√°lido"); return; }
  const fechaISO = fechaSel ? new Date(fechaSel + "T12:00:00").toISOString() : new Date().toISOString();
  movimientos.push({ id: Date.now(), fecha: fechaISO, tipo, monto, billetera, desc });
  guardar();
  document.getElementById('monto').value = '';
  document.getElementById('descripcion').value = '';
  document.getElementById('fechaMov').value = today();
  renderTodo();
}

function editarMovimiento(id){
  const m = movimientos.find(x => x.id === id);
  if(!m) return;
  
  const nuevoMonto = parseFloat(prompt("Nuevo monto (USD):", m.monto));
  if(isNaN(nuevoMonto) || nuevoMonto <= 0) {
    if (nuevoMonto !== null) {
      alert("Monto inv√°lido");
    }
    return;
  }
  
  const fechaActual = new Date(m.fecha).toISOString().slice(0, 10);
  const nuevaFechaStr = prompt("Nueva fecha (AAAA-MM-DD):", fechaActual);
  
  if (nuevaFechaStr && !/^\d{4}-\d{2}-\d{2}$/.test(nuevaFechaStr)) {
    alert("Formato de fecha inv√°lido. Por favor, use AAAA-MM-DD.");
    return;
  }
  
  const nuevaDesc = prompt("Nueva descripci√≥n:", m.desc || "");
  
  m.monto = nuevoMonto;
  
  if (nuevaFechaStr) {
    m.fecha = new Date(nuevaFechaStr + "T12:00:00").toISOString();
  }

  m.desc = nuevaDesc;
  
  guardar();
  renderTodo();
}

function eliminarMovimiento(id){
  if(!confirm("¬øEliminar este movimiento?")) return;
  movimientos = movimientos.filter(x => x.id !== id);
  guardar(); renderTodo();
}

/* ========== Renderizado tablas, saldos, balance y ventas ========== */
function renderTabla(filtroBilletera = null){
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";
  const filtroMes = document.getElementById('mesFiltro').value;
  let totalMes = 0;
  movimientos.forEach(m => {
    const fecha = new Date(m.fecha);
    const mesStr = fecha.toISOString().slice(0,7);
    if((!filtroMes || filtroMes === mesStr) && (!filtroBilletera || m.billetera === filtroBilletera)){
      const tr = document.createElement("tr");
      tr.className = m.tipo;
      tr.innerHTML = `<td>${fecha.toLocaleDateString()}</td><td>${m.billetera}</td><td>${m.desc||''}</td>
        <td>${m.tipo==='gasto'?'-':''}${formatCurrency(m.monto)}</td>
        <td class="acciones">
          <button onclick="event.stopPropagation();editarMovimiento(${m.id})">Editar</button>
          <button onclick="event.stopPropagation();eliminarMovimiento(${m.id})">Eliminar</button>
        </td>`;
      tr.addEventListener("click", () => {
        document.querySelectorAll("#tabla tbody tr").forEach(r => r.classList.remove("activo"));
        tr.classList.toggle("activo");
      });
      tbody.appendChild(tr);
      totalMes += m.tipo === 'ingreso' ? m.monto : -m.monto;
    }
  });
  document.getElementById("totalMes").textContent = formatCurrency(totalMes);
}

function renderSaldos(){
  const saldos = {};
  billeteras.forEach(b => saldos[b] = 0);
  movimientos.forEach(m => {
    if(saldos.hasOwnProperty(m.billetera)){
       saldos[m.billetera] += m.tipo === 'ingreso' ? m.monto : -m.monto;
    }
  });
  
  const cont = document.getElementById("saldos");
  cont.innerHTML = "";
  billeteras.forEach(b => {
    const div = document.createElement("div");
    const monto = saldos[b];
    const colorClass = monto < 0 ? "rojo" : "verde";
    div.className = "saldo-box";
    div.innerHTML = `<strong>${b}</strong><br><span class="saldo-monto ${colorClass}">${formatCurrency(monto)}</span>`;
    div.onclick = () => renderTabla(b);
    cont.appendChild(div);
  });
}

function renderBalanceGeneral(){
  let ingresos=0,gastos=0;
  movimientos.forEach(m => { m.tipo === 'ingreso' ? ingresos += m.monto : gastos += m.monto; });
  document.getElementById("ingresosTotal").textContent = formatCurrency(ingresos);
  document.getElementById("gastosTotal").textContent = formatCurrency(gastos);
  document.getElementById("saldoNeto").textContent = formatCurrency(ingresos - gastos);
}

function renderVentasHoy(){
  const hoy = new Date().toISOString().slice(0,10);
  let total = 0;
  movimientos.forEach(m => {
    if(m.tipo==='ingreso' && m.fecha.slice(0,10) === hoy) total += m.monto;
  });
  document.getElementById("ventasHoy").textContent = formatCurrency(total);
}

function renderTodo(){
  // Ordenar los movimientos por fecha (de m√°s nuevo a m√°s antiguo)
  movimientos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  renderTabla();
  renderSaldos();
  renderBalanceGeneral();
  renderVentasHoy();
}

/* utilidad */
function today(){ return new Date().toISOString().slice(0,10); }
document.getElementById('fechaMov').value = today();

/* === Estad√≠sticas / Gr√°ficos === */
function abrirPaginaVentas(){
  document.getElementById('paginaPrincipal').style.display='none';
  document.getElementById('paginaVentas').style.display='block';
  mostrarEstadisticas();
}
function cerrarPaginaVentas(){
  document.getElementById('paginaVentas').style.display='none';
  document.getElementById('paginaPrincipal').style.display='block';
}

function mostrarEstadisticas(){
  const desde=document.getElementById('desdeVenta').value;
  const hasta=document.getElementById('hastaVenta').value;
  const lista=document.getElementById('listaVentas');
  let filtrados = movimientos.filter(m => m.tipo === 'ingreso');
  if(desde) filtrados = filtrados.filter(m => m.fecha.slice(0,10) >= desde);
  if(hasta) filtrados = filtrados.filter(m => m.fecha.slice(0,10) <= hasta);
  lista.innerHTML = filtrados.map(m => {
    const f = new Date(m.fecha);
    return `<p>${f.toLocaleDateString()} - ${m.billetera}: ${formatCurrency(m.monto)}</p>`;
  }).join('') || '<em>Sin ventas</em>';

  // por d√≠a
  const porDia = {};
  filtrados.forEach(m => { const d = m.fecha.slice(0,10); porDia[d] = (porDia[d]||0) + m.monto; });
  const dias = Object.keys(porDia).sort();
  const dataDia = dias.map(d => porDia[d] * getFactor());
  if(window.grafDia) window.grafDia.destroy();
  window.grafDia = new Chart(document.getElementById('graficoDias'), {
    type: 'line',
    data: { labels: dias, datasets: [{ label:`Ventas (${document.getElementById('monedaSelect').value})`, data: dataDia, borderColor:'#3a86ff', fill:false, tension:0.2, pointRadius:4 }] },
    options: { scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } }, maintainAspectRatio: false }
  });

  // por mes
  const porMes = {};
  filtrados.forEach(m => {
    const d = new Date(m.fecha);
    const k = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
    porMes[k] = (porMes[k]||0) + m.monto;
  });
  const meses = Object.keys(porMes).sort();
  const dataMes = meses.map(k => porMes[k] * getFactor());
  if(window.grafMes) window.grafMes.destroy();
  window.grafMes = new Chart(document.getElementById('graficoMes'), {
    type: 'line',
    data: { labels: meses, datasets: [{ label:`Ventas Mensuales (${document.getElementById('monedaSelect').value})`, data: dataMes, borderColor:'#38b000', fill:false, tension:0.2, pointRadius:4 }] },
    options: { scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } }, maintainAspectRatio: false }
  });
}

/* Init */
renderWallets();
renderTodo();

/* PWA registration (opcional) */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
</script>
</body>
</html>
